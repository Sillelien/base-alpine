machine:
  services:
    - docker
  environment:
#    RELEASE: 0.9.4-${CIRCLE_BUILD_NUM}
    RELEASE: 0.9.3-${CIRCLE_BUILD_NUM}

dependencies:
  cache_directories:
    - "~/bin"

  override:
      - mkdir -p ~/bin
      - cd ~ && git clone https://github.com/sillelien/build-utils.git && chmod a+x ~/build-utils/*.sh
      - sudo curl -L https://github.com/docker/compose/releases/download/1.4.0rc3/docker-compose-Linux-x86_64 >  ~/bin/docker-compose
      - chmod +x /usr/local/bin/docker-compose
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker build -t sillelien/base-alpine:${CIRCLE_BRANCH} .

test:
  override:
    - ~/bin/docker-compose up && [ -f ./docker-test/test.txt ]

deployment:
  staging:
      branch: staging
      commands:
         - ~/build-utils/promote_from_staging.sh

  production:
      branch: master
      commands:
          - docker tag sillelien/base-alpine:${CIRCLE_BRANCH} sillelien/base-alpine
          - docker push sillelien/base-alpine
          - docker tag sillelien/base-alpine sillelien/base-alpine:$(cat .release)
          - docker push sillelien/base-alpine:$(cat .release)


  development:
      branch: dev
      commands:
          - docker push sillelien/base-alpine:${CIRCLE_BRANCH}