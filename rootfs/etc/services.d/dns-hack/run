#!/usr/bin/with-contenv ash

touch /etc/dnsmasq-resolv.conf

echo "Waiting for dnsmasq"
while ! ps -ef | grep -v grep | grep dnsmasq-resolv.conf  &> /dev/null
do
    sleep 1
done

echo "Starting DNS monitoring loop"
while true
do
    if  ( cat /etc/resolv.conf | grep "nameserver 127.0.0.1" &> /dev/null )
    then
        sleep 30
    else
        cp -f /etc/resolv.conf /etc/dnsmasq-resolv.conf
        echo "nameserver 127.0.0.1" > /etc/resolv.conf
    fi

    cp -f /etc/hosts.orig /tmp/hosts
    if env | grep "TUTUM_CONTAINER_FQDN"
    then
        echo "We're running on Tutum"

        . /bin/get_hosts_from_tutum.sh

        . /bin/tutum_dns_hack.sh
    else

        . /bin/non_tutum_dns_hack.sh
    fi

     cp -f /etc/hosts /tmp/hosts.orig

     sort -u < /tmp/hosts > /etc/hosts

     if ! diff /etc/hosts /tmp/hosts.orig
     then
        echo "Updating DNS values"
        killall -HUP dnsmasq  &> /dev/null
     else
        echo "No change to DNS values"
     fi
     sleep 5
done
